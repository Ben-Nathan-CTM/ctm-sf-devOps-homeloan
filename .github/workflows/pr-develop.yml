name: Pull Request to Develop

on:
  pull_request:
    branches: [ develop ]

jobs:
  validate_pull_request:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Install Salesforce CLI
        run: | 
            npm install @salesforce/cli --location=global
            nodeInstallPath=$(npm config get prefix)
            echo "$nodeInstallPath/bin" >> $GITHUB_PATH
            sf --version
  
      - name: Install jq
        run: |
            sudo apt-get install jq

      - name: Populate auth file
        shell: bash
        run: 'echo ${{ secrets.DEVHUB_SFDX_URL }} > ./DEVHUB_SFDX_URL.txt'
  
      - name: Authenticate Dev Hub
        run: 'sf org login sfdx-url -f ./DEVHUB_SFDX_URL.txt -a devhub -d'

      - name: Create scratch org
        run: 'sfdx force:org:create -f config/project-scratch-def.json -a ctm_scratch -s -d 1'

      # - name: Install all the dependency packages for home loan
      #   run:  chmod +x ./installPackages.sh
      #         ./installPackages.sh
      - name: Install Packages
        run: |
          PACKAGES=(04t960000000S8kAAE 04t960000000S5gAAE 04t960000000S5lAAE 04t960000000S5WAAU 04t960000000SfLAAU  04tOm0000000HGzIAM    04t3m000002D9hu 04t5Y0000023R28QAE 04t6g000008So61AAC 04tOm0000000FqHIAU   04tOm0000000GBFIA2     04tOm0000000PsrIAE   04tOm0000000Bt7IAE 04t6g000008C6lwAAC 04t0o000002qOIyAAM    04t5w000003gWWBAA2)
          for package in "${PACKAGES[@]}"; do
            echo "Installing $package..."
            # Replace the below command with the sfdx command to install the package
            sfdx force:package:install -p "$package" -w 10 -b 10 -r
          done
    
      - name: Push source to scratch org
        run: 'sfdx force:package:install -p 04tOm0000000xjFIAQ -w 10 -r'

      - name: Check code coverage
        run: |
            sfdx force:apex:test:run --codecoverage --resultformat json --synchronous --testlevel RunLocalTests --wait 10 > tests.json
            coverage=$(jq .result.summary.orgWideCoverage tests.json | grep -Eo "[[:digit:]]+")
            test $coverage -ge 75
            
      - name: Delete scratch org
        if: always()
        run: 'sfdx force:org:delete -p -u ctm_scratch'

