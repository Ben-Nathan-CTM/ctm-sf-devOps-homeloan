name: Pull Request to Develop

on:
  pull_request:
    branches: [ develop ]

jobs:
  validate_pull_request:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Install Salesforce CLI
        run: | 
            npm install @salesforce/cli --location=global
            nodeInstallPath=$(npm config get prefix)
            echo "$nodeInstallPath/bin" >> $GITHUB_PATH
            sf --version
  
      - name: Install jq
        run: |
            sudo apt-get install jq

      - name: Populate auth file
        shell: bash
        run: 'echo ${{ secrets.DEVHUB_SFDX_URL }} > ./DEVHUB_SFDX_URL.txt'
  
      - name: Authenticate Dev Hub
        run: 'sf org login sfdx-url -f ./DEVHUB_SFDX_URL.txt -a devhub -d'

      - name: Create scratch org
        run: 'sfdx force:org:create -f config/project-scratch-def.json -a ctm_scratch -s -d 1'

      - name: Install all the dependency packages for home loan
        run:  chmod +x ./installPackages.sh
              ./installPackages.sh
    
      - name: Push source to scratch org
        run: 'sfdx force:package:install -p 04tOm0000000xjFIAQ -w 10 -r'

      - name: Check code coverage
        run: |
            sfdx force:apex:test:run --codecoverage --resultformat json --synchronous --testlevel RunLocalTests --wait 10 > tests.json
            coverage=$(jq .result.summary.orgWideCoverage tests.json | grep -Eo "[[:digit:]]+")
            test $coverage -ge 75
            
      - name: Delete scratch org
        if: always()
        run: 'sfdx force:org:delete -p -u ctm_scratch'

